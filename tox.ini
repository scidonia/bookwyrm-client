[tox]
envlist = dev-local
requires = tox-uv>=1.28.0
minversion = 4.0

[testenv]
package = skip
runner = uv-venv-runner

deps =
    -r requirements-integration.txt

    dev: -e .
    v014: bookwyrm==0.1.4
    v013: bookwyrm==0.1.3
    latest: bookwyrm
pass_env = BOOKWYRM_API_KEY
set_env =
    # defaults (full suite, all endpoints, local)
    FEATURE_MARK =
    PATH_FILTER =
    PYTEST_MARK_EXPR = not localonly
    BOOKWYRM_API_URL = http://localhost:8000

    # suite → which path filter to use
    cli: PATH_FILTER = -k test_cli
    library: PATH_FILTER = -k test_library
    sync: PATH_FILTER = -k "sync and not async"
    async: PATH_FILTER = -k async
    full: PATH_FILTER =

    # feature → which feature tests to run
    classify: FEATURE_MARK = and classify
    phrasal: FEATURE_MARK = and phrasal
    cite: FEATURE_MARK = and cite
    summarize: FEATURE_MARK = and summarize
    pdf: FEATURE_MARK = and pdf
    all: FEATURE_MARK =

    # endpoint → which mark expression to include/exclude
    live: PYTEST_MARK_EXPR = not localonly 
    local: PYTEST_MARK_EXPR = not liveonly 

    # endpoint → URL
    local: BOOKWYRM_API_URL = http://localhost:8000
    live: BOOKWYRM_API_URL = https://api.bookwyrm.ai

commands =
    pytest integration/ -v --tb=short -m "{env:PYTEST_MARK_EXPR} {env:FEATURE_MARK}" {env:PATH_FILTER} {posargs}
